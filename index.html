<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Científica Casio fx-991EX</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Arial', sans-serif;
        }

        body {
            background: #121212;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .calculator-container {
            width: 100%;
            max-width: 420px;
            background: #2d2d2d;
            border-radius: 12px;
            box-shadow: 
                0 10px 25px rgba(0, 0, 0, 0.8),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            overflow: hidden;
            border: 2px solid #444;
            padding: 15px;
        }

        .brand-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            background: linear-gradient(to bottom, #1a1a1a, #000);
            color: white;
            border-radius: 6px 6px 0 0;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .model {
            font-size: 0.75rem;
            color: #ffcc00;
        }

        .solar-panel {
            height: 24px;
            background: linear-gradient(135deg, #0a1a2a, #1a2a3a, #0a1a2a);
            margin: 10px 0;
            border-radius: 4px;
            border: 1px solid #000;
            box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.8);
            position: relative;
            overflow: hidden;
        }

        .solar-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                repeating-linear-gradient(
                    90deg,
                    transparent,
                    transparent 4px,
                    rgba(255, 255, 255, 0.05) 4px,
                    rgba(255, 255, 255, 0.05) 6px
                );
        }

        .display-container {
            background: #0a0a0a;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px inset #333;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.9);
        }

        .mode-indicators {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.7rem;
            color: #7a8a7c;
        }

        .mode-indicator {
            padding: 2px 6px;
            border-radius: 3px;
            background: rgba(0, 0, 0, 0.5);
        }

        .mode-indicator.active {
            background: #4CAF50;
            color: white;
        }

        .display {
            background: #8a9a8c;
            border-radius: 4px;
            padding: 10px 12px;
            text-align: right;
            font-size: 1.8rem;
            font-weight: bold;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            word-break: break-all;
            overflow: hidden;
            color: #1a3a1a;
            font-family: 'Courier New', monospace;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5);
            border: 1px solid #6a7a6c;
        }

        .secondary-display {
            font-size: 0.9rem;
            color: #b0b0b0;
            text-align: right;
            min-height: 20px;
            margin-bottom: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            font-family: 'Arial', sans-serif;
            font-weight: 500;
            background: rgba(0, 0, 0, 0.5);
            padding: 4px 8px;
            border-radius: 3px;
        }

        .keypad {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 6px;
        }

        .calc-btn {
            border: none;
            border-radius: 6px;
            padding: 10px 4px;
            font-size: 0.75rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.1s;
            box-shadow: 
                0 3px 0 #444,
                0 4px 4px rgba(0, 0, 0, 0.5);
            background: #4a4a4a;
            color: #e0e0e0;
            touch-action: manipulation;
            user-select: none;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .calc-btn:active {
            transform: translateY(3px);
            box-shadow: 0 1px 0 #444;
        }

        .btn-number {
            background: #5a5a5a;
            color: #ffffff;
        }

        .btn-number:active {
            background: #4a4a4a;
        }

        .btn-operator {
            background: #ff9500;
            color: white;
        }

        .btn-operator:active {
            background: #e08500;
        }

        .btn-function {
            background: #3a3a3a;
            color: #cccccc;
            font-size: 0.7rem;
        }

        .btn-function:active {
            background: #2a2a2a;
        }

        .btn-equals {
            background: #007bff;
            color: white;
        }

        .btn-equals:active {
            background: #0069d9;
        }

        .btn-shift {
            background: #ffcc00;
            color: #333;
        }

        .btn-alpha {
            background: #ff4444;
            color: white;
        }

        .btn-shift-active {
            background: #ffaa00 !important;
            box-shadow: 0 0 0 2px #ffcc00, 0 3px 0 #444 !important;
        }

        .btn-alpha-active {
            background: #ff2222 !important;
            box-shadow: 0 0 0 2px #ff4444, 0 3px 0 #444 !important;
        }

        .secondary-label {
            position: absolute;
            top: 2px;
            left: 3px;
            font-size: 0.55rem;
            color: #ffcc00;
            font-weight: bold;
        }

        .alpha-label {
            position: absolute;
            top: 2px;
            right: 3px;
            font-size: 0.55rem;
            color: #ff4444;
            font-weight: bold;
        }

        .error {
            color: #ff4444;
            font-weight: bold;
        }

        .success {
            color: #4CAF50;
            font-weight: bold;
        }

        .cursor {
            display: inline-block;
            width: 2px;
            height: 1.2em;
            background-color: #1a3a1a;
            animation: blink 1s infinite;
            margin-left: 2px;
            vertical-align: middle;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        @media (max-width: 480px) {
            .calculator-container {
                max-width: 380px;
                padding: 12px;
            }
            
            .keypad {
                grid-template-columns: repeat(6, 1fr);
                gap: 5px;
            }
            
            .calc-btn {
                padding: 8px 3px;
                font-size: 0.7rem;
            }
            
            .display {
                font-size: 1.6rem;
                min-height: 55px;
            }
            
            .secondary-label, .alpha-label {
                font-size: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="calculator-container">
        <div class="brand-bar">
            <div>CASIO</div>
            <div class="model">fx-991EX</div>
        </div>
        
        <div class="solar-panel"></div>
        
        <div class="display-container">
            <div class="mode-indicators">
                <div>
                    <span class="mode-indicator" id="shiftIndicator">SHIFT</span>
                    <span class="mode-indicator" id="alphaIndicator">ALPHA</span>
                    <span class="mode-indicator" id="hypIndicator">HYP</span>
                </div>
                <div>
                    <span class="mode-indicator" id="modeIndicator">COMP</span>
                    <span class="mode-indicator" id="angleIndicator">DEG</span>
                    <span class="mode-indicator" id="memoryIndicator">M</span>
                </div>
            </div>
            <div class="secondary-display" id="secondaryDisplay"></div>
            <div class="display" id="mainDisplay">0<span class="cursor"></span></div>
        </div>
        
        <div class="keypad">
            <!-- Linha 1: Controles principais -->
            <button class="calc-btn btn-shift" id="shiftBtn" data-action="shift">
                <span class="secondary-label">SETUP</span>
                SHIFT
            </button>
            <button class="calc-btn btn-alpha" id="alphaBtn" data-action="alpha">
                <span class="secondary-label">MODE</span>
                ALPHA
            </button>
            <button class="calc-btn btn-function" data-action="clear">AC</button>
            <button class="calc-btn btn-function" data-action="backspace">DEL</button>
            <button class="calc-btn btn-function" data-action="mode">MODE</button>
            <button class="calc-btn btn-function" data-action="history">HIST</button>
            
            <!-- Linha 2: Funções matemáticas -->
            <button class="calc-btn btn-function" data-action="abs">Abs</button>
            <button class="calc-btn btn-function" data-action="x³">x³</button>
            <button class="calc-btn btn-function" data-action="x¹">x⁻¹</button>
            <button class="calc-btn btn-function" data-action="log">log</button>
            <button class="calc-btn btn-function" data-action="ln">ln</button>
            <button class="calc-btn btn-function" data-action="hyp">HYP</button>
            
            <!-- Linha 3: Funções trigonométricas -->
            <button class="calc-btn btn-function" data-action="sin" data-alpha="A">
                <span class="alpha-label">A</span>
                sin
            </button>
            <button class="calc-btn btn-function" data-action="cos" data-alpha="B">
                <span class="alpha-label">B</span>
                cos
            </button>
            <button class="calc-btn btn-function" data-action="tan" data-alpha="C">
                <span class="alpha-label">C</span>
                tan
            </button>
            <button class="calc-btn btn-function" data-action="negate" data-alpha="D">(-)</button>
            <button class="calc-btn btn-function" data-action="deg" data-alpha="E">°'"</button>
            <button class="calc-btn btn-function" data-action="eng" data-alpha="F">ENG</button>
            
            <!-- Linha 4: Memória e parênteses -->
            <button class="calc-btn btn-function" data-action="sto">STO</button>
            <button class="calc-btn btn-function" data-action="rcl">RCL</button>
            <button class="calc-btn btn-function" data-action="s-d">S⇔D</button>
            <button class="calc-btn btn-function" data-action="(">(</button>
            <button class="calc-btn btn-function" data-action=")">)</button>
            <button class="calc-btn btn-function" data-action="m+">M+</button>
            
            <!-- Linha 5: Números -->
            <button class="calc-btn btn-number" data-value="7">7</button>
            <button class="calc-btn btn-number" data-value="8">8</button>
            <button class="calc-btn btn-number" data-value="9">9</button>
            <button class="calc-btn btn-function" data-action="delete">DEL</button>
            <button class="calc-btn btn-function" data-action="percentage">%</button>
            <button class="calc-btn btn-function" data-action="sqrt">√</button>
            
            <!-- Linha 6: Números -->
            <button class="calc-btn btn-number" data-value="4">4</button>
            <button class="calc-btn btn-number" data-value="5">5</button>
            <button class="calc-btn btn-number" data-value="6">6</button>
            <button class="calc-btn btn-operator" data-action="multiply">×</button>
            <button class="calc-btn btn-operator" data-action="divide">÷</button>
            <button class="calc-btn btn-function" data-action="pol">Pol</button>
            
            <!-- Linha 7: Números -->
            <button class="calc-btn btn-number" data-value="1">1</button>
            <button class="calc-btn btn-number" data-value="2">2</button>
            <button class="calc-btn btn-number" data-value="3">3</button>
            <button class="calc-btn btn-operator" data-action="add">+</button>
            <button class="calc-btn btn-operator" data-action="subtract">-</button>
            <button class="calc-btn btn-function" data-action="rnd">Rnd</button>
            
            <!-- Linha 8: Final -->
            <button class="calc-btn btn-number" data-value="0">0</button>
            <button class="calc-btn btn-number" data-action="decimal">.</button>
            <button class="calc-btn btn-function" data-action="exp">EXP</button>
            <button class="calc-btn btn-function" data-action="ans">Ans</button>
            <button class="calc-btn btn-equals" data-action="equals">=</button>
            <button class="calc-btn btn-function" data-action="ranint">RanInt</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elementos da interface
            const mainDisplay = document.getElementById('mainDisplay');
            const secondaryDisplay = document.getElementById('secondaryDisplay');
            const shiftBtn = document.getElementById('shiftBtn');
            const alphaBtn = document.getElementById('alphaBtn');
            
            // Indicadores
            const shiftIndicator = document.getElementById('shiftIndicator');
            const alphaIndicator = document.getElementById('alphaIndicator');
            const hypIndicator = document.getElementById('hypIndicator');
            const modeIndicator = document.getElementById('modeIndicator');
            const angleIndicator = document.getElementById('angleIndicator');
            const memoryIndicator = document.getElementById('memoryIndicator');
            
            // Variáveis de estado
            let currentInput = '0';
            let previousInput = '';
            let operation = null;
            let waitingForNewInput = false;
            let calculationHistory = [];
            let shiftMode = false;
            let alphaMode = false;
            let hypMode = false;
            let lastAnswer = null;
            let isDegreeMode = true;
            let memory = {
                'A': 0, 'B': 0, 'C': 0, 'D': 0, 'E': 0, 'F': 0,
                'X': 0, 'Y': 0, 'M': 0
            };
            let currentMode = 'COMP';
            let isEngineeringMode = false;
            let cursorVisible = true;

            // Inicialização
            updateDisplay();
            updateIndicators();
            startCursorBlink();
            
            // Event Listeners
            document.querySelectorAll('.calc-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const action = button.getAttribute('data-action');
                    const value = button.getAttribute('data-value');
                    const alphaAction = button.getAttribute('data-alpha');
                    
                    let actualAction = action || value;
                    
                    if (alphaMode && alphaAction) {
                        handleMemoryVariable(alphaAction);
                        alphaMode = false;
                        updateIndicators();
                        updateButtonStates();
                        return;
                    }
                    
                    handleButtonClick(actualAction);
                });
            });
            
            document.addEventListener('keydown', handleKeyboardInput);
            
            // Funções principais
            function handleButtonClick(action) {
                if (!isNaN(action)) {
                    inputNumber(action);
                } else if (action === 'decimal') {
                    inputDecimal();
                } else if (action === 'shift') {
                    shiftMode = !shiftMode;
                    alphaMode = false;
                    updateIndicators();
                    updateButtonStates();
                    return;
                } else if (action === 'alpha') {
                    alphaMode = !alphaMode;
                    shiftMode = false;
                    updateIndicators();
                    updateButtonStates();
                    return;
                } else if (action === 'hyp') {
                    hypMode = !hypMode;
                    updateIndicators();
                    showMessage(`Modo ${hypMode ? 'HYP' : 'Normal'} ativado`);
                    return;
                } else {
                    handleOperation(action);
                }
                updateDisplay();
            }
            
            function inputNumber(num) {
                if (waitingForNewInput) {
                    currentInput = num;
                    waitingForNewInput = false;
                } else {
                    currentInput = currentInput === '0' ? num : currentInput + num;
                }
            }
            
            function inputDecimal() {
                if (waitingForNewInput) {
                    currentInput = '0.';
                    waitingForNewInput = false;
                } else if (currentInput.indexOf('.') === -1) {
                    currentInput += '.';
                }
            }
            
            function handleOperation(op) {
                switch (op) {
                    case 'clear':
                        clearAll();
                        break;
                    case 'backspace':
                    case 'delete':
                        deleteLast();
                        break;
                    case 'equals':
                        calculate();
                        break;
                    case 'add':
                    case 'subtract':
                    case 'multiply':
                    case 'divide':
                        setOperation(op);
                        break;
                    case 'abs':
                        calculateAbsolute();
                        break;
                    case 'x³':
                        calculateCube();
                        break;
                    case 'x¹':
                        calculateReciprocal();
                        break;
                    case 'log':
                        calculateLog();
                        break;
                    case 'ln':
                        calculateLn();
                        break;
                    case 'sin':
                        calculateTrig('sin');
                        break;
                    case 'cos':
                        calculateTrig('cos');
                        break;
                    case 'tan':
                        calculateTrig('tan');
                        break;
                    case 'negate':
                        negateNumber();
                        break;
                    case 'deg':
                        convertToDegree();
                        break;
                    case 'eng':
                        toggleEngineering();
                        break;
                    case 'sto':
                        handleMemoryOperation('store');
                        break;
                    case 'rcl':
                        handleMemoryOperation('recall');
                        break;
                    case 's-d':
                        toggleFractionDecimal();
                        break;
                    case '(':
                        inputNumber('(');
                        break;
                    case ')':
                        inputNumber(')');
                        break;
                    case 'm+':
                        memoryAdd();
                        break;
                    case 'percentage':
                        calculatePercent();
                        break;
                    case 'sqrt':
                        calculateSquareRoot();
                        break;
                    case 'pol':
                        calculatePolar();
                        break;
                    case 'rnd':
                        generateRandom();
                        break;
                    case 'exp':
                        inputNumber('E');
                        break;
                    case 'ans':
                        if (lastAnswer !== null) {
                            inputNumber(lastAnswer.toString());
                        }
                        break;
                    case 'ranint':
                        generateRandomInteger();
                        break;
                    case 'mode':
                        toggleMode();
                        break;
                    case 'history':
                        showHistory();
                        break;
                }
            }
            
            function setOperation(op) {
                if (currentInput !== '') {
                    if (previousInput !== '' && !waitingForNewInput) {
                        calculate();
                    }
                    operation = op;
                    previousInput = currentInput;
                    waitingForNewInput = true;
                    updateDisplay();
                }
            }
            
            function calculate() {
                if (previousInput === '' || operation === null || waitingForNewInput) {
                    return;
                }
                
                let result;
                const prev = parseExpression(previousInput);
                const current = parseExpression(currentInput);
                
                if (isNaN(prev) || isNaN(current)) {
                    displayError('Erro de sintaxe');
                    return;
                }
                
                try {
                    switch (operation) {
                        case 'add':
                            result = prev + current;
                            break;
                        case 'subtract':
                            result = prev - current;
                            break;
                        case 'multiply':
                            result = prev * current;
                            break;
                        case 'divide':
                            if (current === 0) {
                                throw new Error('Divisão por zero');
                            }
                            result = prev / current;
                            break;
                    }
                    
                    if (isNaN(result) || !isFinite(result)) {
                        throw new Error('Resultado indefinido');
                    }
                    
                    const operationSymbol = getOperationSymbol(operation);
                    addToHistory(`${previousInput} ${operationSymbol} ${currentInput} = ${formatResult(result)}`);
                    
                    lastAnswer = result;
                    currentInput = formatResult(result);
                    operation = null;
                    previousInput = '';
                    waitingForNewInput = true;
                } catch (error) {
                    displayError(error.message);
                }
            }
            
            function parseExpression(expr) {
                try {
                    // Substitui constantes e funções básicas
                    let processed = expr
                        .replace(/π/g, Math.PI.toString())
                        .replace(/e/g, Math.E.toString())
                        .replace(/E/g, '*10^');
                    
                    // Avaliação segura da expressão
                    return Function('"use strict"; return (' + processed + ')')();
                } catch (error) {
                    return NaN;
                }
            }
            
            function calculateAbsolute() {
                try {
                    const value = parseExpression(currentInput);
                    const result = Math.abs(value);
                    addToHistory(`|${value}| = ${formatResult(result)}`);
                    currentInput = formatResult(result);
                    waitingForNewInput = true;
                } catch (error) {
                    displayError('Erro no cálculo do valor absoluto');
                }
            }
            
            function calculateCube() {
                try {
                    const value = parseExpression(currentInput);
                    const result = Math.pow(value, 3);
                    addToHistory(`${value}³ = ${formatResult(result)}`);
                    currentInput = formatResult(result);
                    waitingForNewInput = true;
                } catch (error) {
                    displayError('Erro no cálculo do cubo');
                }
            }
            
            function calculateReciprocal() {
                try {
                    const value = parseExpression(currentInput);
                    if (value === 0) {
                        throw new Error('Divisão por zero');
                    }
                    const result = 1 / value;
                    addToHistory(`1/${value} = ${formatResult(result)}`);
                    currentInput = formatResult(result);
                    waitingForNewInput = true;
                } catch (error) {
                    displayError(error.message);
                }
            }
            
            function calculateSquareRoot() {
                try {
                    const value = parseExpression(currentInput);
                    if (value < 0) {
                        throw new Error('Raiz de número negativo');
                    }
                    const result = Math.sqrt(value);
                    addToHistory(`√${value} = ${formatResult(result)}`);
                    currentInput = formatResult(result);
                    waitingForNewInput = true;
                } catch (error) {
                    displayError(error.message);
                }
            }
            
            function calculateTrig(func) {
                try {
                    let value = parseExpression(currentInput);
                    
                    if (isDegreeMode && !hypMode) {
                        value = value * Math.PI / 180;
                    }
                    
                    let result;
                    switch (func) {
                        case 'sin':
                            result = hypMode ? Math.sinh(value) : Math.sin(value);
                            break;
                        case 'cos':
                            result = hypMode ? Math.cosh(value) : Math.cos(value);
                            break;
                        case 'tan':
                            result = hypMode ? Math.tanh(value) : Math.tan(value);
                            break;
                    }
                    
                    if (isNaN(result) || !isFinite(result)) {
                        throw new Error('Resultado indefinido');
                    }
                    
                    const modeText = isDegreeMode ? 'DEG' : 'RAD';
                    const hypText = hypMode ? 'HYP ' : '';
                    addToHistory(`${hypText}${func}(${currentInput}) ${modeText} = ${formatResult(result)}`);
                    
                    currentInput = formatResult(result);
                    waitingForNewInput = true;
                    hypMode = false;
                    updateIndicators();
                } catch (error) {
                    displayError('Erro na função trigonométrica');
                }
            }
            
            function calculateLog() {
                try {
                    const value = parseExpression(currentInput);
                    if (value <= 0) {
                        throw new Error('Log de número ≤ 0');
                    }
                    const result = Math.log10(value);
                    addToHistory(`log(${value}) = ${formatResult(result)}`);
                    currentInput = formatResult(result);
                    waitingForNewInput = true;
                } catch (error) {
                    displayError(error.message);
                }
            }
            
            function calculateLn() {
                try {
                    const value = parseExpression(currentInput);
                    if (value <= 0) {
                        throw new Error('ln de número ≤ 0');
                    }
                    const result = Math.log(value);
                    addToHistory(`ln(${value}) = ${formatResult(result)}`);
                    currentInput = formatResult(result);
                    waitingForNewInput = true;
                } catch (error) {
                    displayError(error.message);
                }
            }
            
            function negateNumber() {
                if (currentInput !== '0') {
                    if (currentInput.charAt(0) === '-') {
                        currentInput = currentInput.substring(1);
                    } else {
                        currentInput = '-' + currentInput;
                    }
                }
            }
            
            function convertToDegree() {
                try {
                    const value = parseExpression(currentInput);
                    const degrees = Math.floor(value);
                    const minutes = Math.floor((value - degrees) * 60);
                    const seconds = ((value - degrees - minutes/60) * 3600).toFixed(2);
                    const result = `${degrees}°${minutes}'${seconds}"`;
                    addToHistory(`${value} = ${result}`);
                    currentInput = result;
                    waitingForNewInput = true;
                } catch (error) {
                    displayError('Erro na conversão para graus');
                }
            }
            
            function toggleEngineering() {
                isEngineeringMode = !isEngineeringMode;
                showMessage(`Modo ${isEngineeringMode ? 'ENG' : 'Normal'} ativado`);
            }
            
            function handleMemoryOperation(op) {
                if (op === 'store') {
                    const variable = prompt('Digite a variável (A-F, X, Y, M):');
                    if (variable && /^[A-FXYM]$/i.test(variable)) {
                        const value = parseExpression(currentInput);
                        if (!isNaN(value)) {
                            memory[variable.toUpperCase()] = value;
                            memoryIndicator.classList.add('active');
                            showMessage(`${variable} = ${formatResult(value)}`);
                        } else {
                            displayError('Valor inválido');
                        }
                    }
                } else if (op === 'recall') {
                    const variable = prompt('Digite a variável (A-F, X, Y, M):');
                    if (variable && memory[variable.toUpperCase()] !== undefined) {
                        currentInput = memory[variable.toUpperCase()].toString();
                        showMessage(`Recuperado ${variable} = ${memory[variable.toUpperCase()]}`);
                    } else {
                        displayError('Variável não encontrada');
                    }
                }
                updateDisplay();
            }
            
            function handleMemoryVariable(variable) {
                if (shiftMode) {
                    // Modo STO - armazenar
                    const value = parseExpression(currentInput);
                    if (!isNaN(value)) {
                        memory[variable] = value;
                        memoryIndicator.classList.add('active');
                        showMessage(`${variable} = ${formatResult(value)}`);
                    } else {
                        displayError('Valor inválido');
                    }
                } else {
                    // Modo RCL - recuperar
                    if (memory[variable] !== undefined) {
                        currentInput = memory[variable].toString();
                        showMessage(`Recuperado ${variable} = ${memory[variable]}`);
                    } else {
                        displayError('Variável não encontrada');
                    }
                }
                updateDisplay();
            }
            
            function memoryAdd() {
                const value = parseExpression(currentInput);
                if (!isNaN(value)) {
                    memory['M'] = (memory['M'] || 0) + value;
                    memoryIndicator.classList.add('active');
                    showMessage(`M = ${formatResult(memory['M'])}`);
                } else {
                    displayError('Valor inválido');
                }
            }
            
            function toggleFractionDecimal() {
                if (currentInput.includes('/')) {
                    const parts = currentInput.split('/');
                    const numerator = parseFloat(parts[0]);
                    const denominator = parseFloat(parts[1]);
                    if (denominator !== 0 && !isNaN(numerator) && !isNaN(denominator)) {
                        currentInput = (numerator / denominator).toString();
                        showMessage('Convertido para decimal');
                    } else {
                        displayError('Fração inválida');
                    }
                } else {
                    const value = parseFloat(currentInput);
                    if (!isNaN(value)) {
                        // Conversão simples para fração
                        const precision = 0.0001;
                        for (let denominator = 1; denominator <= 1000; denominator++) {
                            const numerator = Math.round(value * denominator);
                            if (Math.abs(value - numerator/denominator) < precision) {
                                currentInput = `${numerator}/${denominator}`;
                                showMessage('Convertido para fração');
                                break;
                            }
                        }
                    } else {
                        displayError('Valor inválido');
                    }
                }
            }
            
            function calculatePercent() {
                try {
                    const value = parseExpression(currentInput);
                    const result = value / 100;
                    addToHistory(`${value}% = ${formatResult(result)}`);
                    currentInput = formatResult(result);
                    waitingForNewInput = true;
                } catch (error) {
                    displayError('Erro no cálculo de %');
                }
            }
            
            function calculatePolar() {
                try {
                    const values = currentInput.split(',');
                    if (values.length !== 2) {
                        throw new Error('Use formato: x,y');
                    }
                    const x = parseFloat(values[0]);
                    const y = parseFloat(values[1]);
                    if (isNaN(x) || isNaN(y)) {
                        throw new Error('Valores inválidos');
                    }
                    const r = Math.sqrt(x*x + y*y);
                    const theta = Math.atan2(y, x);
                    const result = `r=${formatResult(r)}, θ=${formatResult(theta)}`;
                    addToHistory(`Pol(${x},${y}) = ${result}`);
                    currentInput = result;
                    waitingForNewInput = true;
                } catch (error) {
                    displayError(error.message);
                }
            }
            
            function generateRandom() {
                const result = Math.random();
                addToHistory(`Rnd = ${formatResult(result)}`);
                currentInput = formatResult(result);
                waitingForNewInput = true;
            }
            
            function generateRandomInteger() {
                const min = parseInt(prompt('Valor mínimo:') || '1');
                const max = parseInt(prompt('Valor máximo:') || '100');
                if (isNaN(min) || isNaN(max) || min >= max) {
                    displayError('Valores inválidos');
                    return;
                }
                const result = Math.floor(Math.random() * (max - min + 1)) + min;
                addToHistory(`RanInt(${min},${max}) = ${result}`);
                currentInput = result.toString();
                waitingForNewInput = true;
            }
            
            function toggleMode() {
                const modes = ['COMP', 'STAT', 'TABLE', 'EQN'];
                const currentIndex = modes.indexOf(currentMode);
                currentMode = modes[(currentIndex + 1) % modes.length];
                modeIndicator.textContent = currentMode;
                showMessage(`Modo ${currentMode} ativado`);
            }
            
            function toggleAngleMode() {
                const modes = ['DEG', 'RAD', 'GRAD'];
                const currentIndex = modes.indexOf(angleIndicator.textContent);
                angleIndicator.textContent = modes[(currentIndex + 1) % modes.length];
                isDegreeMode = angleIndicator.textContent === 'DEG';
                showMessage(`Ângulo: ${angleIndicator.textContent}`);
            }
            
            function showHistory() {
                if (calculationHistory.length === 0) {
                    showMessage('Histórico vazio');
                } else {
                    alert('Histórico:\n' + calculationHistory.join('\n'));
                }
            }
            
            function clearAll() {
                currentInput = '0';
                previousInput = '';
                operation = null;
                waitingForNewInput = false;
                showMessage('Calculadora limpa');
            }
            
            function deleteLast() {
                if (currentInput.length > 1) {
                    currentInput = currentInput.slice(0, -1);
                } else {
                    currentInput = '0';
                }
            }
            
            function displayError(message) {
                secondaryDisplay.innerHTML = `<span class="error">${message}</span>`;
                setTimeout(() => {
                    updateDisplay();
                }, 3000);
            }
            
            function showMessage(message) {
                secondaryDisplay.innerHTML = `<span class="success">${message}</span>`;
                setTimeout(() => {
                    updateDisplay();
                }, 2000);
            }
            
            function addToHistory(entry) {
                calculationHistory.unshift(entry);
                if (calculationHistory.length > 10) {
                    calculationHistory.pop();
                }
            }
            
            function updateDisplay() {
                mainDisplay.innerHTML = currentInput + (waitingForNewInput ? '' : '<span class="cursor"></span>');
                
                if (previousInput !== '' && operation !== null) {
                    secondaryDisplay.textContent = `${previousInput} ${getOperationSymbol(operation)}`;
                } else if (!secondaryDisplay.innerHTML.includes('class="error"') && 
                          !secondaryDisplay.innerHTML.includes('class="success"')) {
                    secondaryDisplay.textContent = '';
                }
            }
            
            function updateIndicators() {
                shiftIndicator.classList.toggle('active', shiftMode);
                alphaIndicator.classList.toggle('active', alphaMode);
                hypIndicator.classList.toggle('active', hypMode);
                memoryIndicator.classList.toggle('active', Object.values(memory).some(val => val !== 0));
            }
            
            function updateButtonStates() {
                shiftBtn.classList.toggle('btn-shift-active', shiftMode);
                alphaBtn.classList.toggle('btn-alpha-active', alphaMode);
            }
            
            function formatResult(result) {
                if (typeof result !== 'number' || isNaN(result)) {
                    return 'Erro';
                }
                
                if (isEngineeringMode) {
                    const exponent = Math.floor(Math.log10(Math.abs(result)));
                    const mantissa = result / Math.pow(10, exponent);
                    return `${mantissa.toFixed(4)}E${exponent}`;
                }
                
                if (Math.abs(result) > 1e10 || (Math.abs(result) < 1e-5 && result !== 0)) {
                    return result.toExponential(6);
                }
                
                // Arredonda para evitar problemas de ponto flutuante
                return Math.round(result * 1e10) / 1e10;
            }
            
            function getOperationSymbol(op) {
                switch (op) {
                    case 'add': return '+';
                    case 'subtract': return '-';
                    case 'multiply': return '×';
                    case 'divide': return '÷';
                    default: return '';
                }
            }
            
            function startCursorBlink() {
                setInterval(() => {
                    cursorVisible = !cursorVisible;
                    updateDisplay();
                }, 500);
            }
            
            function handleKeyboardInput(e) {
                const key = e.key;
                
                if (!isNaN(key)) {
                    inputNumber(key);
                } else {
                    switch (key) {
                        case '+':
                            handleOperation('add');
                            break;
                        case '-':
                            handleOperation('subtract');
                            break;
                        case '*':
                            handleOperation('multiply');
                            break;
                        case '/':
                            e.preventDefault();
                            handleOperation('divide');
                            break;
                        case 'Enter':
                        case '=':
                            e.preventDefault();
                            handleOperation('equals');
                            break;
                        case 'Escape':
                            handleOperation('clear');
                            break;
                        case 'Backspace':
                            handleOperation('backspace');
                            break;
                        case '.':
                            inputDecimal();
                            break;
                        case '%':
                            handleOperation('percentage');
                            break;
                    }
                }
                
                updateDisplay();
            }
        });
    </script>
</body>
</html>
